<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ê–Ω—è</title>

  <!-- –®—Ä–∏—Ñ—Ç Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root {
      --gold: #d4af37;
      --glass: rgba(255, 255, 255, 0.03);
      --text: #f7f3f0;
    }
    html, body {
      height: 100%;
      margin: 0;
      /* –ü—Ä–∏–±—Ä–∞–Ω–æ —á–æ—Ä–Ω–∏–π —Ñ–æ–Ω */
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
    }

    /* LOADER */
    .arjs-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1); /* –ü—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω –ª–æ–∞–¥–µ—Ä–∞ */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: var(--gold);
      font-size: 1.4em;
      text-align: center;
      z-index: 9999;
      font-family: Inter, sans-serif;
      padding: 20px;
      box-sizing: border-box;
    }
    .arjs-loader h2 {
      margin: 0 0 16px 0;
      font-weight: 700;
      font-size: 1.8em;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .pulse { animation: pulse 2s infinite; }

    /* Top HUD */
    .hud {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 12px;
      z-index: 40;
      display: flex;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .hud.active { opacity: 1; }
    .btn {
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.35));
      border: 1px solid rgba(212, 175, 55, 0.15);
      padding: 8px 12px;
      border-radius: 10px;
      color: var(--gold);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(6px);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn.small { padding: 6px 10px; font-size: 14px; border-radius: 8px; }
    .btn.gold {
      background: linear-gradient(90deg, rgba(212, 175, 55, 0.12), rgba(212, 175, 55, 0.06));
      color: var(--black);
      border: 1px solid rgba(212, 175, 55, 0.95);
    }

    /* Center menu shown after video */
    .menu {
      position: fixed;
      left: 50%;
      top: 60%;
      transform: translate(-50%, -50%);
      z-index: 40;
      display: none;
      gap: 12px;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(180deg, rgba(11, 11, 11, 0.85), rgba(11, 11, 11, 0.6));
      border: 1px solid rgba(212, 175, 55, 0.12);
      padding: 16px;
      border-radius: 12px;
      min-width: 220px;
      text-align: center;
    }
    .menu h3 { margin: 4px 0 8px 0; color: var(--gold); }

    /* Game overlay full-screen */
    .game-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8); /* –ü—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω –¥–ª—è –æ–≤–µ—Ä–ª–µ—é */
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      color: var(--text);
      padding: 20px;
    }
    .game-ui {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      text-align: center;
    }
    .game-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .timer {
      color: var(--gold);
      font-weight: 700;
    }

    /* Canvas style ‚Äî –∞–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–æ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    canvas#gameCanvas {
      width: 100%;
      max-width: 420px; /* –û–±–º–µ–∂–µ–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó —à–∏—Ä–∏–Ω–∏ */
      height: auto; /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≤–∏—Å–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π */
      border-radius: 10px;
      background: transparent;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      touch-action: none;
    }

    /* Small gold label */
    .label-gold {
      display: inline-block;
      color: var(--gold);
      font-weight: 700;
      font-size: 14px;
    }

    /* Victory popup */
    .victory {
      margin-top: 12px;
      display: none;
      color: var(--gold);
      font-weight: 800;
      font-size: 18px;
    }

    /* Mobile adjustments */
    @media (max-width: 480px) {
      .hud { top: 6px; gap: 6px; }
      .menu { top: 58%; min-width: 180px; }
      canvas#gameCanvas { max-width: 100%; height: 60vh; } /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div class="arjs-loader" id="loader">
    <h2 class="pulse">–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ ü™Ω</h2>
    <div>–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ</div>
  </div>

  <!-- HUD: Play/Stop/Buttons -->
  <div class="hud" role="toolbar" aria-label="controls">
    <button id="btnPlay" class="btn small" title="Play video">‚ñ∂ Play</button>
    <button id="btnStop" class="btn small" title="Stop video">‚è∏ Stop</button>
    <div style="width: 8px"></div>
    <button id="btnGame1" class="btn" title="–ì—Ä–∞ 1: Love Match">üéÆ –ì—Ä–∞ 1</button>
    <button id="btnGame2" class="btn" title="–ì—Ä–∞ 2: –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞">üéÆ –ì—Ä–∞ 2</button>
  </div>

  <!-- Center menu -->
  <div id="menu" class="menu" aria-hidden="true">
    <h3>–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É</h3>
    <button id="menuGame1" class="btn small" aria-label="–ì—Ä–∞ Love Match">‚ù§Ô∏èü™Ω Love Match</button>
    <button id="menuGame2" class="btn small" aria-label="–ì—Ä–∞ –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞">ü™Ω –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞</button>
    <div style="height: 6px"></div>
    <button id="menuBack" class="btn small">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ AR</button>
  </div>

  <!-- MindAR scene -->
  <a-scene
    mindar-image="imageTargetSrc: https://lessa2332.github.io/ana/marker.mind; autoStart: true; uiLoading: no; uiError: no;"
    embedded
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    id="scene">

    <a-assets>
      <video id="video1" src="video1.mp4" muted crossorigin="anonymous" playsinline webkit-playsinline preload="auto" loop="false"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane id="videoPlane" position="0 0 0" rotation="0 0 0" width="0.85" height="1.5" material="shader: flat; src: #video1; transparent: false; opacity: 1" visible="false"></a-plane>

      <a-entity position="0 0 -0.01">
        <a-ring radius-inner="0.8" radius-outer="0.82" rotation="-90 0 0" color="#d4af37" visible="false" id="goldRing"></a-ring>
      </a-entity>
    </a-entity>

  </a-scene>

  <!-- Game overlay -->
  <div id="gameOverlay" class="game-overlay" role="dialog" aria-modal="true">
    <div class="game-ui">
      <div class="game-top">
        <div class="label-gold" id="gameTitle">–ì—Ä–∞</div>
        <div class="timer" id="gameTimer"></div>
      </div>

      <canvas id="gameCanvas"></canvas>

      <div class="victory" id="victoryText"></div>

      <div style="height: 12px"></div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="btnRestart" class="btn small">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button id="btnBackToAR" class="btn small">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ AR</button>
      </div>
    </div>
  </div>

  <!-- –ü—ñ–¥–∫–∞–∑–∫–∞ –ø—Ä–æ –º–∞—Ä–∫–µ—Ä -->
  <div id="markerHint">–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω</div>

  <!-- Scripts -->
  <script>
    // ---- Controls references ----
    const loader = document.getElementById('loader');
    const videoEl = document.getElementById('video1');
    const btnPlay = document.getElementById('btnPlay');
    const btnStop = document.getElementById('btnStop');
    const menu = document.getElementById('menu');
    const btnGame1 = document.getElementById('btnGame1');
    const btnGame2 = document.getElementById('btnGame2');
    const menuGame1 = document.getElementById('menuGame1');
    const menuGame2 = document.getElementById('menuGame2');
    const menuBack = document.getElementById('menuBack');

    const gameOverlay = document.getElementById('gameOverlay');
    const gameCanvas = document.getElementById('gameCanvas');
    const gameTitle = document.getElementById('gameTitle');
    const gameTimer = document.getElementById('gameTimer');
    const victoryText = document.getElementById('victoryText');
    const btnBackToAR = document.getElementById('btnBackToAR');
    const btnRestart = document.getElementById('btnRestart');
    const markerHint = document.getElementById('markerHint');
    const videoPlane = document.getElementById('videoPlane');

    // –°—Ç–∞–Ω AR
    let isMarkerFound = false;

    // –§—É–Ω–∫—Ü—ñ—ó –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    function lockScroll() {
      document.body.style.overflow = 'hidden';
    }
    function unlockScroll() {
      document.body.style.overflow = '';
    }

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ
    videoEl.addEventListener('error', () => {
      console.error('Failed to load video1.mp4');
      alert('–í—ñ–¥–µ–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª video1.mp4 –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ—Ä—É—á —ñ–∑ —Ü–∏–º HTML-—Ñ–∞–π–ª–æ–º.');
    });

    function ensurePlayAllowed() {
      const p = videoEl.play();
      if (p && p.then) {
        p.then(() => {
          videoEl.pause();
        }).catch(() => {/* ignore */});
      }
    }

    // –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
    btnPlay.addEventListener('click', () => {
      if (isMarkerFound) {
        videoEl.play().catch(() => {
          markerHint.style.display = 'block';
          setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
        });
      } else {
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
      }
    });

    btnStop.addEventListener('click', () => {
      if (isMarkerFound) {
        videoEl.pause();
        videoEl.currentTime = 0;
        showMenu();
      } else {
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
      }
    });

    // –ì—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è AR
    function checkARAndOpenGame(name) {
      if (!isMarkerFound) {
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
        return;
      }
      openGame(name);
    }

    btnGame1.addEventListener('click', () => checkARAndOpenGame('love'));
    btnGame2.addEventListener('click', () => checkARAndOpenGame('pilot'));
    menuGame1.addEventListener('click', () => checkARAndOpenGame('love'));
    menuGame2.addEventListener('click', () => checkARAndOpenGame('pilot'));

    function showMenu() {
      if (isMarkerFound) {
        menu.style.display = 'flex';
        menu.setAttribute('aria-hidden', 'false');
      }
    }
    function hideMenu() {
      menu.style.display = 'none';
      menu.setAttribute('aria-hidden', 'true');
    }

    videoEl.addEventListener('ended', () => {
      if (isMarkerFound) showMenu();
    });

    const scene = document.querySelector('a-scene');

    scene.addEventListener('renderstart', () => {
      ensurePlayAllowed();
    });

    scene.addEventListener('targetFound', (ev) => {
      isMarkerFound = true;
      loader.style.display = 'none';
      markerHint.style.display = 'none';

      const ring = document.getElementById('goldRing');
      ring.setAttribute('visible', 'true');
      setTimeout(() => ring.setAttribute('visible', 'false'), 900);

      videoPlane.setAttribute('visible', 'true');

      if (!videoEl.paused && !videoEl.ended) {
        videoEl.play().catch(() => {});
      }

      hideMenu();
    });

    scene.addEventListener('targetLost', (ev) => {
      isMarkerFound = false;
      if (!videoEl.paused) videoEl.pause();
      videoPlane.setAttribute('visible', 'false');
      hideMenu();
    });

    menuBack.addEventListener('click', () => {
      if (isMarkerFound) hideMenu();
    });

    btnBackToAR.addEventListener('click', closeGame);
    btnRestart.addEventListener('click', () => {
      if (currentGame === 'love') startLoveMatch();
      if (currentGame === 'pilot') startPilot();
    });

    // ---- Game implementations ----
    let currentGame = null;
    let gameLoopHandle = null;
    let pilotTimerHandle = null;
    let loveTimerHandle = null;

    function openGame(name) {
      lockScroll();
      if (!isMarkerFound) return;
      if (!videoEl.paused) videoEl.pause();
      hideMenu();
      currentGame = name;
      gameOverlay.style.display = 'flex';
      victoryText.style.display = 'none';
      if (name === 'love') {
        gameTitle.textContent = 'Love Match ‚ù§Ô∏èü™Ω';
        startLoveMatch();
      } else if (name === 'pilot') {
        gameTitle.textContent = '–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ ü™Ω';
        startPilot();
      }
    }

    function closeGame() {
      if (gameOverlay._cleanup) {
        try { gameOverlay._cleanup(); } catch (e) {}
        gameOverlay._cleanup = null;
      }
      stopAllGameLoops();
      gameOverlay.style.display = 'none';
      currentGame = null;
      victoryText.style.display = 'none';
      unlockScroll();
    }

    function stopAllGameLoops() {
      if (gameLoopHandle) { cancelAnimationFrame(gameLoopHandle); gameLoopHandle = null; }
      if (pilotTimerHandle) { clearInterval(pilotTimerHandle); pilotTimerHandle = null; }
      if (loveTimerHandle) { clearInterval(loveTimerHandle); loveTimerHandle = null; }
      const ctx = gameCanvas.getContext('2d');
      ctx && ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    }

    function fitCanvas() {
      const ratio = window.devicePixelRatio || 1;
      const maxWidth = Math.min(window.innerWidth - 40, 420);
      const aspectRatio = 9 / 16; // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
      const maxHeight = window.innerHeight * 0.62;
      const finalHeight = Math.min(maxWidth / aspectRatio, maxHeight);

      gameCanvas.style.width = maxWidth + 'px';
      gameCanvas.style.height = finalHeight + 'px';
      gameCanvas.width = Math.round(maxWidth * ratio);
      gameCanvas.height = Math.round(finalHeight * ratio);
    }
    window.addEventListener('resize', fitCanvas);
    fitCanvas();

    /* ----------------- Game 1: Love Match ----------------- */
    function startLoveMatch() {
      stopAllGameLoops();
      fitCanvas();
      const ctx = gameCanvas.getContext('2d');
      const sequence = ['‚ù§Ô∏è', 'ü™Ω'];
      let step = 0;
      let score = 0;
      let fallingEmojis = [];
      let gameTime = 30; // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≥—Ä—É
      let appearInterval = 600; // –®–≤–∏–¥—à–∏–π –ø–æ—è–≤–∞

      function spawnEmoji() {
        if (fallingEmojis.length >= 5) return;
        const isTarget = Math.random() < 0.65;
        const emoji = isTarget ? sequence[step % sequence.length] : ['üéÇ', 'üç∑', 'üåπ', 'üòÇ', 'üéÅ', 'üê±', '‚ú®'][Math.floor(Math.random() * 7)];
        const size = Math.round(gameCanvas.height * 0.1);
        const x = Math.random() * (gameCanvas.width - size) + size / 2;
        fallingEmojis.push({ emoji, x, y: -size, size, vy: 2 + Math.random(), isTarget });
      }

      function draw() {
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.font = '20px serif'; // –ú–µ–Ω—à–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö
        fallingEmojis.forEach((f, i) => {
          f.y += f.vy;
          if (f.y > gameCanvas.height + f.size) fallingEmojis.splice(i, 1);
          else {
            ctx.fillStyle = f.isTarget ? '#ff69b4' : '#fff'; // –†–æ–∂–µ–≤–∏–π –¥–ª—è —Ü—ñ–ª–µ–π
            ctx.fillText(f.emoji, f.x, f.y);
          }
        });

        if (Math.random() < 0.03) spawnEmoji();

        ctx.font = Math.round(gameCanvas.height * 0.05) + 'px sans-serif';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('Score: ' + score, gameCanvas.width * 0.5, gameCanvas.height * 0.92);

        gameLoopHandle = requestAnimationFrame(draw);
      }
      draw();

      gameTimer.textContent = gameTime + 's';
      loveTimerHandle = setInterval(() => {
        gameTime -= 1;
        gameTimer.textContent = gameTime + 's';
        if (gameTime <= 0) {
          clearInterval(loveTimerHandle);
          endLoveMatch();
        }
      }, 1000);

      function onTap(e) {
        const rect = gameCanvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        for (let i = fallingEmojis.length - 1; i >= 0; i--) {
          const f = fallingEmojis[i];
          if (Math.abs(x - f.x) < f.size / 2 && Math.abs(y - f.y) < f.size / 2) {
            if (f.isTarget) {
              score += 1;
              flashText('+1 ‚ù§Ô∏è');
            } else {
              score = Math.max(0, score - 1);
              flashText('-1 üíî');
            }
            fallingEmojis.splice(i, 1);
            break;
          }
        }
        if (score >= 10) {
          clearInterval(loveTimerHandle);
          endLoveMatch(true);
        }
      }

      gameCanvas.addEventListener('pointerdown', onTap);

      function endLoveMatch(isVictory = false) {
        gameCanvas.removeEventListener('pointerdown', onTap);
        cancelAnimationFrame(gameLoopHandle);
        if (isVictory) {
          ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
          ctx.font = Math.round(gameCanvas.height * 0.2) + 'px serif';
          ctx.fillStyle = '#d4af37';
          ctx.fillText('üë©‚Äç‚ù§Ô∏è‚Äçüë®', gameCanvas.width / 2, gameCanvas.height / 2 - 20);
          ctx.font = Math.round(gameCanvas.height * 0.06) + 'px sans-serif';
          ctx.fillText('–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ –°–ª–∞–≤–æ—á–∫—É!', gameCanvas.width / 2, gameCanvas.height / 2 + 20);
          victoryText.style.display = 'block';
          victoryText.textContent = '–ü–µ—Ä–µ–º–æ–≥–∞! üíï';
        } else {
          victoryText.style.display = 'block';
          victoryText.textContent = '–ß–∞—Å –≤–∏–π—à–æ–≤ ‚Äî —Å–ø—Ä–æ–±—É–π —â–µ!';
        }
      }

      function flashText(txt) {
        victoryText.style.display = 'block';
        victoryText.style.color = '#d4af37';
        victoryText.textContent = txt;
        setTimeout(() => { victoryText.style.display = 'none'; }, 500);
      }

      gameOverlay._cleanup = function() {
        clearInterval(loveTimerHandle);
        gameCanvas.removeEventListener('pointerdown', onTap);
      };
    }

    /* ----------------- Game 2: –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ ----------------- */
    function startPilot(level = 1) {
      stopAllGameLoops();
      fitCanvas();
      const ctx = gameCanvas.getContext('2d');
      gameTimer.textContent = '30s';
      let pilotRemaining = 30;
      let pilotY = gameCanvas.height * 0.5;
      let pilotX = gameCanvas.width * 0.5;
      let speedUp = -22 - (level * 4);
      let gravity = 2.8 + (level * 0.6);
      let vy = 0;
      let caught = 0;
      let requiredToWin = 8 + (level * 4);
      let fallingEmojis = [];
      const allEmojis = ['ü™Ω', 'üéÇ', 'üç∑', 'üê±', 'üåπ', 'üéÅ', '‚ú®', 'üíç', 'üçæ', 'üéâ', 'üíº', 'üì±', 'üåü', 'üï∂Ô∏è', 'üç´'];
      const obstacles = ['üöß', 'üå™Ô∏è'];

      function spawnEmoji() {
        if (fallingEmojis.length >= 10 + level * 2) return;
        const e = allEmojis[Math.floor(Math.random() * allEmojis.length)];
        const size = Math.round(gameCanvas.height * 0.09);
        const x = Math.random() * (gameCanvas.width - size) + size / 2;
        fallingEmojis.push({ emoji: e, x, y: -size, size, vy: 3 + level * 0.5 });
      }

      function spawnObstacle() {
        if (level < 2 || fallingEmojis.length >= 12) return;
        const e = obstacles[Math.floor(Math.random() * obstacles.length)];
        const size = Math.round(gameCanvas.height * 0.1);
        const x = Math.random() * (gameCanvas.width - size) + size / 2;
        fallingEmojis.push({ emoji: e, x, y: -size, size, vy: 4 + level * 0.5, isObstacle: true });
      }

      for (let i = 0; i < 10 + level * 2; i++) spawnEmoji();

      function draw() {
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        // –î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ñ–æ–Ω –∑ –µ—Ñ–µ–∫—Ç–æ–º
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

        fallingEmojis.forEach((f, i) => {
          f.y += f.vy;
          if (f.y > gameCanvas.height + f.size) {
            fallingEmojis.splice(i, 1);
            if (Math.random() < 0.5) spawnEmoji();
            if (level >= 2 && Math.random() < 0.3) spawnObstacle();
          } else {
            ctx.font = Math.round(f.size) + 'px serif';
            ctx.fillStyle = f.isObstacle ? '#f44336' : (f.emoji === 'ü™Ω' ? '#00bcd4' : '#fff');
            ctx.fillText(f.emoji, f.x, f.y);
          }
        });

        vy += gravity;
        pilotY += vy;
        if (pilotY > gameCanvas.height * 0.84) { pilotY = gameCanvas.height * 0.84; vy = 0; }
        if (pilotY < 0) { pilotY = 0; vy = 0; }

        ctx.font = Math.round(gameCanvas.height * 0.1) + 'px serif';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('üë®', pilotX, pilotY);

        ctx.font = Math.round(gameCanvas.height * 0.045) + 'px sans-serif';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('–ö—Ä–∏–ª–∞: ' + caught, gameCanvas.width * 0.85, gameCanvas.height * 0.08);
        if (level >= 2) ctx.fillText('–†—ñ–≤–µ–Ω—å 2', gameCanvas.width * 0.15, gameCanvas.height * 0.08);

        gameLoopHandle = requestAnimationFrame(draw);
      }
      draw();

      pilotTimerHandle = setInterval(() => {
        pilotRemaining -= 1;
        gameTimer.textContent = pilotRemaining + 's';
        if (pilotRemaining <= 0) {
          clearInterval(pilotTimerHandle);
          endPilot();
        }
      }, 1000);

      function onTap(e) {
        const rect = gameCanvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        pilotX = Math.max(0, Math.min(x, gameCanvas.width)); // –†—É—Ö –ø–æ X
        for (let i = fallingEmojis.length - 1; i >= 0; i--) {
          const f = fallingEmojis[i];
          if (Math.abs(x - f.x) < f.size / 2 && Math.abs(y - f.y) < f.size / 2) {
            fallingEmojis.splice(i, 1);
            if (f.isObstacle) {
              vy += 12 + level * 4;
              flashText('–ü–µ—Ä–µ—à–∫–æ–¥–∞!');
            } else if (f.emoji === 'ü™Ω') {
              caught += 1;
              vy = speedUp;
              flashText('+1 –∫—Ä–∏–ª–æ!');
            } else {
              vy += 6 + level * 2;
              flashText('–ù–µ —Ç–µ!');
            }
            break;
          }
        }
        if (caught >= requiredToWin) {
          clearInterval(pilotTimerHandle);
          endPilot(true);
        }
      }

      gameCanvas.addEventListener('pointerdown', onTap);
      gameCanvas.addEventListener('touchstart', onTap);

      function endPilot(isVictory = false) {
        gameCanvas.removeEventListener('pointerdown', onTap);
        gameCanvas.removeEventListener('touchstart', onTap);
        cancelAnimationFrame(gameLoopHandle);
        if (isVictory) {
          if (level === 1) {
            victoryText.style.display = 'block';
            victoryText.textContent = '–†—ñ–≤–µ–Ω—å 1 –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü–æ—á–∞—Ç–∏ —Ä—ñ–≤–µ–Ω—å 2?';
            btnRestart.textContent = '–†—ñ–≤–µ–Ω—å 2';
            btnRestart.onclick = () => startPilot(2);
          } else {
            showPilotVictory();
          }
        } else {
          victoryText.style.display = 'block';
          victoryText.textContent = '–ì—Ä–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å ‚Äî —Å–ø—Ä–æ–±—É–π —â–µ!';
        }
      }

      function showPilotVictory() {
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.font = Math.round(gameCanvas.height * 0.22) + 'px serif';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('üíã', gameCanvas.width / 2, gameCanvas.height * 0.44);
        ctx.font = Math.round(gameCanvas.height * 0.06) + 'px sans-serif';
        ctx.fillText('–ê–Ω—è –Ω–∞–¥–∞–ª–∞ –∫—Ä–∏–ª–∞! –ü–æ—Ü—ñ–ª—É–π —ó—ó!', gameCanvas.width / 2, gameCanvas.height * 0.68);
        victoryText.style.display = 'block';
        victoryText.style.color = '#d4af37';
        victoryText.textContent = '–ê–Ω—è –Ω–∞–¥–∞–ª–∞ –∫—Ä–∏–ª–∞! –ü–æ—Ü—ñ–ª—É–π —ó—ó! üòò';
      }

      function flashText(txt) {
        victoryText.style.display = 'block';
        victoryText.style.color = '#d4af37';
        victoryText.textContent = txt;
        setTimeout(() => { victoryText.style.display = 'none'; }, 700);
      }

      gameOverlay._cleanup = function() {
        clearInterval(pilotTimerHandle);
        gameCanvas.removeEventListener('pointerdown', onTap);
        gameCanvas.removeEventListener('touchstart', onTap);
      };
    }

    hideMenu();
    setTimeout(() => {
      if (loader.style.display !== 'none') {
        loader.style.display = 'none';
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 4000);
      }
    }, 5000);

    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isMarkerFound) {
        if (!videoEl.paused) videoEl.pause();
      }
    });

    document.body.addEventListener('pointerdown', function _initAudioOnce() {
      ensurePlayAllowed();
      document.body.removeEventListener('pointerdown', _initAudioOnce);
    });
  </script>
</body>
</html>
