<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ê–Ω—è</title>

  <!-- –®—Ä–∏—Ñ—Ç Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root {
      --gold: #d4af37;
      --black: #0b0b0b;
      --glass: rgba(255, 255, 255, 0.03);
      --text: #f7f3f0;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--black);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      touch-action: none;
    }

    /* Top HUD */
    .hud {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 12px;
      z-index: 40;
      display: flex;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
    }
    .btn {
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.35));
      border: 1px solid rgba(212, 175, 55, 0.15);
      padding: 8px 12px;
      border-radius: 10px;
      color: var(--gold);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(6px);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn.small { padding: 6px 10px; font-size: 14px; border-radius: 8px; }
    .btn.gold {
      background: linear-gradient(90deg, rgba(212, 175, 55, 0.12), rgba(212, 175, 55, 0.06));
      color: var(--black);
      border: 1px solid rgba(212, 175, 55, 0.95);
    }

    /* Center menu shown after video */
    .menu {
      position: fixed;
      left: 50%;
      top: 60%;
      transform: translate(-50%, -50%);
      z-index: 40;
      display: none;
      gap: 12px;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(180deg, rgba(11, 11, 11, 0.85), rgba(11, 11, 11, 0.6));
      border: 1px solid rgba(212, 175, 55, 0.12);
      padding: 16px;
      border-radius: 12px;
      min-width: 220px;
      text-align: center;
    }
    .menu h3 { margin: 4px 0 8px 0; color: var(--gold); }

    /* Game overlay full-screen */
    .game-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.88), rgba(6, 6, 6, 0.96));
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      color: var(--text);
      padding: 20px;
    }
    .game-ui {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      text-align: center;
    }
    .game-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .timer {
      color: var(--gold);
      font-weight: 700;
    }

    /* Canvas style ‚Äî –ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω! */
    canvas#gameCanvas {
      width: 100%;
      height: 70vh;
      border-radius: 10px;
      background: transparent;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      touch-action: none;
    }

    /* Small gold label */
    .label-gold {
      display: inline-block;
      color: var(--gold);
      font-weight: 700;
      font-size: 14px;
    }

    /* Victory popup */
    .victory {
      margin-top: 12px;
      display: none;
      color: var(--gold);
      font-weight: 800;
      font-size: 18px;
    }

    /* Mobile adjustments */
    @media (max-width: 480px) {
      .hud { top: 6px; gap: 6px; }
      .menu { top: 58%; min-width: 180px; }
      canvas#gameCanvas { height: 62vh; }
    }

    /* –õ–æ–∞–¥–µ—Ä */
    .arjs-loader {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(135, 206, 235, 0.95);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #d4af37;
      font-size: 1.8em;
      text-align: center;
      padding: 20px;
      font-family: Inter, sans-serif;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .pulse { animation: pulse 1.5s infinite; }

    /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –º–∞—Ä–∫–µ—Ä */
    #markerHint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: var(--gold);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      z-index: 30;
      display: none;
    }
  </style>
</head>
<body>

  <!-- –õ–æ–∞–¥–µ—Ä -->
  <div class="arjs-loader" id="loader">
    <div class="pulse">‚ú® –ê–Ω—è AR-–≤—ñ–∑–∏—Ç–∫–∞ ‚ú®</div>
    <div style="margin-top: 20px; font-size: 1.2em;">–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä! üòä</div>
  </div>

  <!-- HUD: Play/Stop/Buttons -->
  <div class="hud" role="toolbar" aria-label="controls">
    <button type="button" id="btnPlay" class="btn small" title="Play video">‚ñ∂ Play</button>
    <button type="button" id="btnStop" class="btn small" title="Stop video">‚è∏ Stop</button>
    <div style="width: 8px"></div>
    <button type="button" id="btnGame1" class="btn" title="–ì—Ä–∞ 1: Love Match">üéÆ –ì—Ä–∞ 1</button>
    <button type="button" id="btnGame2" class="btn" title="–ì—Ä–∞ 2: –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞">üéÆ –ì—Ä–∞ 2</button>
  </div>

  <!-- Center menu -->
  <div id="menu" class="menu" aria-hidden="true">
    <h3>–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É</h3>
    <button type="button" id="menuGame1" class="btn small" aria-label="–ì—Ä–∞ Love Match">‚ù§Ô∏èü™Ω Love Match</button>
    <button type="button" id="menuGame2" class="btn small" aria-label="–ì—Ä–∞ –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞">ü™Ω –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞</button>
    <div style="height: 6px"></div>
    <button type="button" id="menuBack" class="btn small">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ AR</button>
  </div>

  <!-- MindAR scene -->
  <a-scene
    mindar-image="imageTargetSrc: marker.mind; autoStart: true; uiLoading: no; uiError: no;"
    embedded
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true">

    <a-assets>
      <video id="video1" src="video1.mp4" muted crossorigin="anonymous" playsinline webkit-playsinline preload="auto" loop="false">
        <source src="video1.mp4" type="video/mp4">
        <source src="video1.webm" type="video/webm">
      </video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <!-- –í—ñ–¥–µ–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ —Å–ø–æ—á–∞—Ç–∫—É -->
      <a-plane id="videoPlane" position="0 0 0" rotation="0 0 0" width="1.5" height="0.85" material="shader: flat; src: #video1; transparent: false; opacity: 1" visible="false"></a-plane>
      <a-entity position="0 0 -0.01">
        <a-ring radius-inner="0.8" radius-outer="0.82" rotation="-90 0 0" color="#d4af37" visible="false" id="goldRing"></a-ring>
      </a-entity>
    </a-entity>
  </a-scene>

  <!-- Game overlay -->
  <div id="gameOverlay" class="game-overlay" role="dialog" aria-modal="true">
    <div class="game-ui">
      <div class="game-top">
        <div class="label-gold" id="gameTitle">–ì—Ä–∞</div>
        <div class="timer" id="gameTimer"></div>
      </div>
      <canvas id="gameCanvas"></canvas>
      <div class="victory" id="victoryText"></div>
      <div style="height: 12px"></div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button type="button" id="btnRestart" class="btn small">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        <button type="button" id="btnBackToAR" class="btn small">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ AR</button>
      </div>
    </div>
  </div>

  <!-- –ü—ñ–¥–∫–∞–∑–∫–∞ –ø—Ä–æ –º–∞—Ä–∫–µ—Ä -->
  <div id="markerHint" role="alert" aria-live="polite">–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω</div>

  <!-- Scripts -->
  <script>
    // –ü–æ–ª—ñ—Ñ—ñ–ª –¥–ª—è Math.hypot
    if (!Math.hypot) {
      Math.hypot = function(x, y) {
        return Math.sqrt(x * x + y * y);
      };
    }

    // –§—É–Ω–∫—Ü—ñ—è debounce
    function debounce(fn, ms) {
      let timer;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), ms);
      };
    }

    // ---- Controls references ----
    const videoEl = document.getElementById('video1');
    const btnPlay = document.getElementById('btnPlay');
    const btnStop = document.getElementById('btnStop');
    const menu = document.getElementById('menu');
    const btnGame1 = document.getElementById('btnGame1');
    const btnGame2 = document.getElementById('btnGame2');
    const menuGame1 = document.getElementById('menuGame1');
    const menuGame2 = document.getElementById('menuGame2');
    const menuBack = document.getElementById('menuBack');
    const gameOverlay = document.getElementById('gameOverlay');
    const gameCanvas = document.getElementById('gameCanvas');
    const gameTitle = document.getElementById('gameTitle');
    const gameTimer = document.getElementById('gameTimer');
    const victoryText = document.getElementById('victoryText');
    const btnBackToAR = document.getElementById('btnBackToAR');
    const btnRestart = document.getElementById('btnRestart');
    const markerHint = document.getElementById('markerHint');
    const videoPlane = document.getElementById('videoPlane');
    const loader = document.getElementById('loader');

    // –°—Ç–∞–Ω AR
    let isMarkerFound = false;

    // –§—É–Ω–∫—Ü—ñ—ó –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    function lockScroll() {
      document.body.style.overflow = 'hidden';
    }
    function unlockScroll() {
      document.body.style.overflow = '';
    }

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ
    videoEl.addEventListener('error', () => {
      console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è video1.mp4');
      alert('–í—ñ–¥–µ–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª video1.mp4 –∞–±–æ video1.webm —î –≤ —Ç—ñ–π —Å–∞–º—ñ–π –ø–∞–ø—Ü—ñ.');
    });

    function ensurePlayAllowed() {
      const p = videoEl.play();
      if (p && p.then) {
        p.then(() => {
          videoEl.pause();
        }).catch(() => {/* ignore */});
      }
    }

    // –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
    btnPlay.addEventListener('click', () => {
      if (isMarkerFound) {
        videoEl.play().catch((e) => {
          console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:', e);
          markerHint.textContent = '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–µ —Ä–∞–∑ –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è';
          markerHint.style.display = 'block';
          setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
        });
      } else {
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
      }
    });

    btnStop.addEventListener('click', () => {
      if (isMarkerFound) {
        videoEl.pause();
        videoEl.currentTime = 0;
        showMenu();
      } else {
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
      }
    });

    // –ì—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è AR
    function checkARAndOpenGame(name) {
      if (!isMarkerFound) {
        markerHint.style.display = 'block';
        setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
        return;
      }
      openGame(name);
    }

    btnGame1.addEventListener('click', () => checkARAndOpenGame('love'));
    btnGame2.addEventListener('click', () => checkARAndOpenGame('pilot'));
    menuGame1.addEventListener('click', () => checkARAndOpenGame('love'));
    menuGame2.addEventListener('click', () => checkARAndOpenGame('pilot'));

    function showMenu() {
      if (isMarkerFound) {
        menu.style.display = 'flex';
        menu.setAttribute('aria-hidden', 'false');
      }
    }
    function hideMenu() {
      menu.style.display = 'none';
      menu.setAttribute('aria-hidden', 'true');
    }

    videoEl.addEventListener('ended', () => {
      if (isMarkerFound) showMenu();
    });

    const scene = document.querySelector('a-scene');

    scene.addEventListener('renderstart', () => {
      ensurePlayAllowed();
    });

    scene.addEventListener('targetFound', (ev) => {
      isMarkerFound = true;
      markerHint.style.display = 'none';
      loader.style.display = 'none';

      const ring = document.getElementById('goldRing');
      ring.setAttribute('visible', 'true');
      setTimeout(() => ring.setAttribute('visible', 'false'), 900);

      videoPlane.setAttribute('visible', 'true');

      if (!videoEl.paused && !videoEl.ended && videoEl.readyState >= 2) {
        videoEl.play().catch((e) => {
          console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:', e);
          markerHint.textContent = '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Play –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è';
          markerHint.style.display = 'block';
          setTimeout(() => { markerHint.style.display = 'none'; }, 3000);
        });
      }

      hideMenu();
    });

    scene.addEventListener('targetLost', (ev) => {
      isMarkerFound = false;
      if (!videoEl.paused) videoEl.pause();
      videoPlane.setAttribute('visible', 'false');
      hideMenu();
    });

    scene.addEventListener('arError', (ev) => {
      console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó AR:', ev.detail);
      loader.style.display = 'none';
      markerHint.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ AR. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.';
      markerHint.style.display = 'block';
    });

    menuBack.addEventListener('click', () => {
      if (isMarkerFound) hideMenu();
    });

    btnBackToAR.addEventListener('click', closeGame);
    btnRestart.addEventListener('click', () => {
      if (currentGame === 'love') startLoveMatch();
      if (currentGame === 'pilot') startPilot();
    });

    // ---- Game implementations ----
    let currentGame = null;
    let gameLoopHandle = null;
    let pilotTimerHandle = null;
    let pilotRemaining = 60;

    function openGame(name) {
      lockScroll();
      if (!isMarkerFound) return;
      if (!videoEl.paused) videoEl.pause();
      hideMenu();
      currentGame = name;
      gameOverlay.style.display = 'flex';
      victoryText.style.display = 'none';
      if (name === 'love') {
        gameTitle.textContent = 'Love Match ‚ù§Ô∏èü™Ω';
        startLoveMatch();
      } else if (name === 'pilot') {
        gameTitle.textContent = '–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ ü™Ω';
        startPilot();
      }
    }

    function closeGame() {
      if (gameOverlay._cleanup) {
        try { gameOverlay._cleanup(); } catch (e) {}
        gameOverlay._cleanup = null;
      }
      stopAllGameLoops();
      gameOverlay.style.display = 'none';
      currentGame = null;
      victoryText.style.display = 'none';
      unlockScroll();
    }

    function stopAllGameLoops() {
      if (gameLoopHandle) { cancelAnimationFrame(gameLoopHandle); gameLoopHandle = null; }
      if (pilotTimerHandle) { clearInterval(pilotTimerHandle); pilotTimerHandle = null; }
      const ctx = gameCanvas.getContext('2d');
      ctx && ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    }

    function fitCanvas() {
      const ratio = window.devicePixelRatio || 1;
      const maxWidth = Math.min(window.innerWidth - 40, 420);
      const maxHeight = window.innerHeight * 0.62;
      const idealHeight = maxWidth * 9 / 16;
      const finalHeight = Math.min(idealHeight, maxHeight);

      gameCanvas.style.width = maxWidth + 'px';
      gameCanvas.style.height = finalHeight + 'px';
      gameCanvas.width = Math.round(maxWidth * ratio);
      gameCanvas.height = Math.round(finalHeight * ratio);
    }
    window.addEventListener('resize', debounce(fitCanvas, 100));
    window.addEventListener('orientationchange', debounce(fitCanvas, 100));
    fitCanvas();

    /* ----------------- Game 1: Love Match ----------------- */
    function startLoveMatch() {
      stopAllGameLoops();
      fitCanvas();
      const ctx = gameCanvas.getContext('2d');
      const sequence = ['‚ù§Ô∏è', 'ü™Ω'];
      let step = 0;
      let score = 0;
      let currentEmoji = null;
      let appearInterval = 900;

      gameTimer.textContent = '';

      function draw() {
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.font = Math.round(gameCanvas.height * 0.35) + 'px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#fff';
        if (currentEmoji) {
          ctx.shadowColor = 'rgba(212, 175, 55, 0.8)';
          ctx.shadowBlur = 18;
          ctx.fillText(currentEmoji, gameCanvas.width / 2, gameCanvas.height / 2);
          ctx.shadowBlur = 0;
        } else {
          ctx.fillText('–ì–æ—Ç—É–π—Å—è...', gameCanvas.width / 2, gameCanvas.height / 2);
        }

        ctx.font = Math.round(gameCanvas.height * 0.05) + 'px sans-serif';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('Score: ' + score, gameCanvas.width * 0.5, gameCanvas.height * 0.92);

        gameLoopHandle = requestAnimationFrame(draw);
      }

      draw();

      let appearTimer = setInterval(() => {
        const distractors = ['üéÇ', 'üç∑', 'üåπ', 'üòÇ', 'üéÅ', 'üê±', '‚ú®'];
        if (Math.random() < 0.60) {
          currentEmoji = sequence[step % sequence.length];
        } else {
          currentEmoji = distractors[Math.floor(Math.random() * distractors.length)];
        }
      }, appearInterval);

      function onTap(e) {
        if (!currentEmoji) return;
        const expected = sequence[step % sequence.length];
        if (currentEmoji === expected) {
          score += 1;
          step += 1;
          currentEmoji = '‚ú®';
          setTimeout(() => { currentEmoji = null; }, 220);
        } else {
          score = Math.max(0, score - 1);
          currentEmoji = '‚ùå';
          setTimeout(() => { currentEmoji = null; }, 300);
        }
        if (score >= 8) {
          clearInterval(appearTimer);
          gameCanvas.removeEventListener('pointerdown', onTap);
          gameCanvas.removeEventListener('touchstart', onTap);
          gameCanvas.removeEventListener('mousedown', onTap);
          cancelAnimationFrame(gameLoopHandle);
          currentEmoji = null;
          showLoveVictory();
        }
      }

      gameCanvas.addEventListener('pointerdown', onTap);
      gameCanvas.addEventListener('touchstart', onTap);
      gameCanvas.addEventListener('mousedown', onTap);

      function showLoveVictory() {
        const ctx = gameCanvas.getContext('2d');
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.font = Math.round(gameCanvas.height * 0.26) + 'px serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('üë©‚Äç‚ù§Ô∏è‚Äçüë®ü™Ω', gameCanvas.width / 2, gameCanvas.height / 2 - 20);
        ctx.font = Math.round(gameCanvas.height * 0.06) + 'px sans-serif';
        ctx.fillText('–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ –°–ª–∞–≤–æ—á–∫—É!', gameCanvas.width / 2, gameCanvas.height / 2 + gameCanvas.height * 0.2);
        victoryText.style.display = 'block';
        victoryText.textContent = '–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ –°–ª–∞–≤–æ—á–∫—É üíï';
      }

      gameOverlay._cleanup = function() {
        clearInterval(appearTimer);
        gameCanvas.removeEventListener('pointerdown', onTap);
        gameCanvas.removeEventListener('touchstart', onTap);
        gameCanvas.removeEventListener('mousedown', onTap);
      };
    }

    /* ----------------- Game 2: –ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ ----------------- */
    function startPilot() {
      stopAllGameLoops();
      fitCanvas();
      const ctx = gameCanvas.getContext('2d');
      gameTimer.textContent = '60s';
      pilotRemaining = 60;
      let pilotY = gameCanvas.height * 0.84;
      let pilotX = gameCanvas.width * 0.12;
      let speedUp = -18;
      let gravity = 2.2;
      let vy = 0;
      let caught = 0;
      let requiredToWin = 8;
      let fallingEmojis = [];
      const allEmojis = ['ü™Ω', 'üéÇ', 'üç∑', 'üê±', 'üåπ', 'üéÅ', '‚ú®', 'üíç', 'üçæ', 'üéâ', 'üíº', 'üì±', 'üåü', 'üï∂Ô∏è', 'üç´'];

      function spawnEmoji() {
        if (fallingEmojis.length >= 8) return;
        const e = allEmojis[Math.floor(Math.random() * allEmojis.length)];
        const size = Math.round(Math.random() * (gameCanvas.height * 0.09) + gameCanvas.height * 0.05);
        const x = Math.random() * (gameCanvas.width * 0.8) + gameCanvas.width * 0.1;
        fallingEmojis.push({ emoji: e, x: x, y: -size, size: size, vy: Math.random() * 1.2 + 0.8 });
      }

      for (let i = 0; i < 8; i++) spawnEmoji();

      function draw() {
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.font = '40px serif';
        for (let i = fallingEmojis.length - 1; i >= 0; i--) {
          const f = fallingEmojis[i];
          f.y += f.vy * 1.6;
          ctx.font = Math.round(f.size) + 'px serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(f.emoji, f.x, f.y + f.size * 0.5);
          if (f.y > gameCanvas.height + 80) {
            fallingEmojis.splice(i, 1);
          }
        }

        if (Math.random() < 0.04) spawnEmoji();

        vy += gravity;
        pilotY += vy;
        const floorY = gameCanvas.height * 0.84;
        if (pilotY > floorY) { pilotY = floorY; vy = 0; }

        const pilotSize = Math.round(gameCanvas.height * 0.10);
        ctx.font = pilotSize + 'px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üë®', pilotX, pilotY);

        ctx.font = Math.round(gameCanvas.height * 0.045) + 'px sans-serif';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('–ö—Ä–∏–ª–∞: ' + caught, gameCanvas.width * 0.85, gameCanvas.height * 0.08);

        gameLoopHandle = requestAnimationFrame(draw);
      }
      draw();

      gameTimer.textContent = pilotRemaining + 's';
      pilotTimerHandle = setInterval(() => {
        pilotRemaining -= 1;
        gameTimer.textContent = pilotRemaining + 's';
        if (pilotRemaining <= 0) {
          clearInterval(pilotTimerHandle);
          pilotTimerHandle = null;
          endPilot();
        }
      }, 1000);

      function onTap(e) {
        const rect = gameCanvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        for (let i = fallingEmojis.length - 1; i >= 0; i--) {
          const f = fallingEmojis[i];
          const fx = f.x;
          const fy = f.y + f.size * 0.5;
          const r = Math.max(f.size * 0.6, 28);
          if (Math.hypot(x - fx, y - fy) < r) {
            const tapped = f.emoji;
            fallingEmojis.splice(i, 1);
            if (tapped === 'ü™Ω') {
              caught += 1;
              vy = speedUp;
              flashText('+1 wing');
            } else {
              vy += 6;
              flashText('–ù–µ —Ç–µ!');
            }
            break;
          }
        }
      }

      function flashText(txt) {
        victoryText.style.display = 'block';
        victoryText.style.color = '#d4af37';
        victoryText.textContent = txt;
        setTimeout(() => { victoryText.style.display = 'none'; }, 700);
      }

      gameCanvas.addEventListener('pointerdown', onTap);
      gameCanvas.addEventListener('touchstart', onTap);
      gameCanvas.addEventListener('mousedown', onTap);

      function endPilot() {
        gameCanvas.removeEventListener('pointerdown', onTap);
        gameCanvas.removeEventListener('touchstart', onTap);
        gameCanvas.removeEventListener('mousedown', onTap);
        cancelAnimationFrame(gameLoopHandle);
        if (caught >= requiredToWin) {
          showPilotVictory();
        } else {
          victoryText.style.display = 'block';
          victoryText.style.color = '#fff';
          victoryText.textContent = '–ì—Ä–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å ‚Äî —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!';
        }
      }

      function showPilotVictory() {
        const ctx = gameCanvas.getContext('2d');
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.font = Math.round(gameCanvas.height * 0.22) + 'px serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#d4af37';
        ctx.fillText('üíã', gameCanvas.width / 2, gameCanvas.height * 0.44);
        ctx.font = Math.round(gameCanvas.height * 0.06) + 'px sans-serif';
        ctx.fillText('–ê–Ω—è –Ω–∞–¥–∞–ª–∞ –∫—Ä–∏–ª–∞! –ü–æ—Ü—ñ–ª—É–π —ó—ó!', gameCanvas.width / 2, gameCanvas.height * 0.68);
        victoryText.style.display = 'block';
        victoryText.style.color = '#d4af37';
        victoryText.textContent = '–ê–Ω—è –Ω–∞–¥–∞–ª–∞ –∫—Ä–∏–ª–∞! –ü–æ—Ü—ñ–ª—É–π —ó—ó! üòò';
      }

      gameOverlay._cleanup = function() {
        clearInterval(pilotTimerHandle);
        pilotTimerHandle = null;
        gameCanvas.removeEventListener('pointerdown', onTap);
        gameCanvas.removeEventListener('touchstart', onTap);
        gameCanvas.removeEventListener('mousedown', onTap);
      };
    }

    hideMenu();
    markerHint.style.display = 'none';
    setTimeout(() => {
      if (loader && loader.style.display !== 'none') {
        loader.style.display = 'none';
      }
    }, 4000);

    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isMarkerFound) {
        if (!videoEl.paused) videoEl.pause();
      }
    });

    document.body.addEventListener('pointerdown', function _initAudioOnce() {
      ensurePlayAllowed();
      document.body.removeEventListener('pointerdown', _initAudioOnce);
    });
  </script>
</body>
</html>
