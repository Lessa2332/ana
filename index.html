<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>–ê–Ω—è - AR –ì—Ä–∞</title>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- A-Frame and MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

   <style>
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
    }

    html, body {
        height: 100%;
        overflow: hidden;
        background: transparent; /* üëà –ß–û–†–û–ù–ò–ô –§–û–ù –ü–†–ò–ë–†–ê–ù–û! */
        font-family: 'Inter', sans-serif;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }

    /* Loading Screen ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ —á–æ—Ä–Ω–∏–º, –±–æ –≤—ñ–Ω —Ç–∏–º—á–∞—Å–æ–≤–∏–π */
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000; /* ‚úÖ –ó–∞–ª–∏—à–∞—î–º–æ —á–æ—Ä–Ω–∏–º ‚Äî —Ü–µ –ª–æ–∞–¥–µ—Ä */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        color: #d4af37;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(212, 175, 55, 0.3);
        border-top: 4px solid #d4af37;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* AR Scene ‚Äî –ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω */
    a-scene {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        opacity: 0;
        transition: opacity 0.5s ease;
        background: transparent; /* üëà –ì–∞—Ä–∞–Ω—Ç—ñ—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ */
    }

    a-scene.ready {
        opacity: 1;
    }

    /* Game Canvas ‚Äî –±–µ–∑ –∑–º—ñ–Ω */
    #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 20;
        pointer-events: auto;
        touch-action: none;
    }

    /* HUD, Feedback, Victory ‚Äî –±–µ–∑ –∑–º—ñ–Ω */

    .hud {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 30;
        text-align: center;
        color: white;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .hud.visible {
        opacity: 1;
    }

    .instructions {
        background: rgba(0, 0, 0, 0.7);
        padding: 8px 16px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 8px;
        backdrop-filter: blur(10px);
    }

    .score {
        background: rgba(212, 175, 55, 0.9);
        color: #000;
        padding: 8px 20px;
        border-radius: 12px;
        font-weight: 800;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .feedback {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        font-weight: 800;
        z-index: 40;
        opacity: 0;
        pointer-events: none;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9);
        text-align: center;
        transition: opacity 0.3s ease;
        padding: 16px 24px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        color: #d4af37;
    }

    .feedback.visible {
        opacity: 1;
    }

    .victory {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: #d4af37;
        padding: 32px;
        border-radius: 24px;
        font-weight: 800;
        font-size: 28px;
        text-align: center;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
        backdrop-filter: blur(20px);
        border: 2px solid #d4af37;
        max-width: 90%;
        box-shadow: 0 8px 32px rgba(212, 175, 55, 0.3);
    }

    .victory.visible {
        opacity: 1;
        pointer-events: auto;
    }

    .victory-message {
        margin-bottom: 20px;
    }

    .continue-btn {
        background: #d4af37;
        color: #000;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-family: 'Inter', sans-serif;
        font-weight: 700;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 16px;
    }

    .continue-btn:hover {
        background: #e6c550;
        transform: scale(1.05);
    }

    /* Marker Hint ‚Äî –±–µ–∑ –∑–º—ñ–Ω */
    #markerHint {
        position: fixed;
        bottom: calc(120px + env(safe-area-inset-bottom, 20px));
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #d4af37;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        z-index: 30;
        opacity: 1;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(10px);
        max-width: 90%;
    }

    #markerHint.hidden {
        opacity: 0;
        pointer-events: none;
    }
/* Video Controls ‚Äî —Ç–µ–ø–µ—Ä —É –í–ï–†–•–ù–¨–û–ú–£ –ü–†–ê–í–û–ú–£ –ö–£–¢–Ü */
.video-controls {
    position: fixed;
    top: 16px;          /* –í—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É */
    right: 16px;        /* –í—ñ–¥—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
    z-index: 35;
    display: flex;
    flex-direction: column; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
    gap: 10px;
    pointer-events: auto;
    width: auto;
    max-width: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.video-controls.visible {
    opacity: 1;
}

.video-btn {
    background: rgba(212, 175, 55, 0.95);
    color: #000;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: auto;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.video-btn:hover {
    background: rgba(212, 175, 55, 1);
    transform: scale(1.03);
}

.video-btn:active {
    transform: scale(0.98);
}

.sound-btn {
    background: rgba(255, 255, 255, 0.9);
}

.sound-btn.on {
    background: rgba(212, 175, 55, 0.95);
}

    /* Error Screen ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ —á–æ—Ä–Ω–∏–º, –±–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞ */
    .error-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
        color: #fff;
        text-align: center;
        padding: 20px;
    }

    .error-screen.visible {
        display: flex;
    }

    .error-icon {
        font-size: 48px;
        margin-bottom: 20px;
    }

    .retry-btn {
        background: #d4af37;
        color: #000;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-family: 'Inter', sans-serif;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
    }
</style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR...</div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div id="errorMessage">–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞</div>
        <button class="retry-btn" id="retryBtn">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>

    <!-- AR Scene -->
    <a-scene
        mindar-image="imageTargetSrc: ./marker.mind; autoStart: true; uiLoading: no; uiError: no; maxTrack: 1;"
        embedded
        color-space="sRGB"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        id="arScene">
        
        <a-assets>
            <video id="video1" src="./video1.mp4" muted playsinline webkit-playsinline preload="auto" loop></video>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –í—ñ–¥–µ–æ "—É –ø–æ–≤—ñ—Ç—Ä—ñ", –∑–±—ñ–ª—å—à–µ–Ω–µ –≤ 2 —Ä–∞–∑–∏ -->
            <a-video
                src="#video1"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="videoEntity">
            </a-video>
        </a-entity>
    </a-scene>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div class="hud" id="hud">
        <div class="instructions">–õ–æ–≤–∏ —Ç—ñ–ª—å–∫–∏ –∫—Ä–∏–ª–∞ ü™Ω</div>
        <div class="score" id="score">–ö—Ä–∏–ª–∞: 0/10</div>
    </div>

    <!-- Feedback -->
    <div class="feedback" id="feedback"></div>

    <!-- Victory Screen -->
    <div class="victory" id="victory">
        <div class="victory-message">–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞! üíã</div>
        <div>–¢–∏ –∑—ñ–±—Ä–∞–≤ —É—Å—ñ –∫—Ä–∏–ª–∞!–ü—Ä–∏–≤—ñ—Ç–∞–π –ê–Ω—É!</div>
        <button class="continue-btn" id="continueBtn">–ì—Ä–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
    </div>

    <!-- Video Controls -->
    <div class="video-controls" id="videoControls">
        <button class="video-btn" id="replayBtn" aria-label="–í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ —â–µ —Ä–∞–∑">‚ñ∂Ô∏è –©–µ —Ä–∞–∑</button>
        <button class="video-btn sound-btn" id="soundBtn" aria-label="–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîá –£–≤—ñ–º–∫. –∑–≤—É–∫</button>
    </div>

    <!-- Marker Hint -->
    <div id="markerHint">–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω</div>

    <script>
        class ARGame {
            constructor() {
                this.initializeElements();
                this.setupGameState();
                this.bindEvents();
                this.adjustControlsForSafeArea(); // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–¥—Ä–∞–∑—É
            }

            initializeElements() {
                this.scene = document.getElementById('arScene');
                this.videoEl = document.getElementById('video1');
                this.videoEntity = document.getElementById('videoEntity');
                this.gameCanvas = document.getElementById('gameCanvas');
                this.ctx = this.gameCanvas.getContext('2d');
                
                this.loadingScreen = document.getElementById('loadingScreen');
                this.errorScreen = document.getElementById('errorScreen');
                this.errorMessage = document.getElementById('errorMessage');
                this.retryBtn = document.getElementById('retryBtn');
                this.hud = document.getElementById('hud');
                this.scoreEl = document.getElementById('score');
                this.feedbackEl = document.getElementById('feedback');
                this.victoryEl = document.getElementById('victory');
                this.continueBtn = document.getElementById('continueBtn');
                this.markerHint = document.getElementById('markerHint');
                this.videoControls = document.getElementById('videoControls');
                this.replayBtn = document.getElementById('replayBtn');
                this.soundBtn = document.getElementById('soundBtn');

                this.validateElements();
                this.resizeCanvas();
            }

            validateElements() {
                const required = [
                    this.scene, this.videoEl, this.gameCanvas, this.ctx,
                    this.loadingScreen, this.hud, this.scoreEl, this.feedbackEl,
                    this.victoryEl, this.markerHint, this.videoControls
                ];
                required.forEach(el => {
                    if (!el) throw new Error('DOM element missing');
                });
            }

            setupGameState() {
                this.gameState = {
                    isMarkerFound: false,
                    score: 0,
                    TARGET_SCORE: 10,
                    fallingItems: [],
                    gameActive: false,
                    animationId: null,
                    soundEnabled: false,
                    lastSpawnTime: 0,
                    SPAWN_INTERVAL: 300,
                    WING_PROBABILITY: 0.6
                };
            }

            bindEvents() {
                window.addEventListener('resize', () => this.throttledResize());
                window.addEventListener('error', (e) => this.handleGlobalError(e));

                // –î–æ–¥–∞—Ç–∫–æ–≤–æ: —Å–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω—É visualViewport (Android)
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        this.adjustControlsForSafeArea();
                    });
                }

                this.gameCanvas.addEventListener('pointerdown', (e) => this.handleTap(e));
                this.gameCanvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });

                this.replayBtn.addEventListener('click', () => this.replayVideo());
                this.soundBtn.addEventListener('click', () => this.toggleSound());
                this.continueBtn.addEventListener('click', () => this.restartGame());
                this.retryBtn.addEventListener('click', () => this.retryAR());

                this.videoEl.addEventListener('loadeddata', () => this.handleVideoLoad());
                this.videoEl.addEventListener('error', (e) => this.handleVideoError(e));
                this.videoEl.addEventListener('ended', () => this.handleVideoEnd());

                this.scene.addEventListener('renderstart', () => this.handleARLoad());
                this.scene.addEventListener('targetFound', () => this.handleTargetFound());
                this.scene.addEventListener('targetLost', () => this.handleTargetLost());
                this.scene.addEventListener('arError', (e) => this.handleARError(e));
            }

            // === –ù–û–í–ò–ô –ú–ï–¢–û–î: –ê–î–ê–ü–¢–ê–¶–Ü–Ø –ü–Ü–î –ü–ê–ù–ï–õ–¨ –ù–ê–í–Ü–ì–ê–¶–Ü–á ===
            adjustControlsForSafeArea() {
                // –Ø–∫—â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è visualViewport ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π–æ–≥–æ
                if (window.visualViewport) {
                    const viewportHeight = window.visualViewport.height;
                    const layoutHeight = window.innerHeight;
                    const navBarHeight = Math.max(0, layoutHeight - viewportHeight);
                    
                    // –î–æ–¥–∞—î–º–æ –º—ñ–Ω—ñ–º—É–º 20px + –≤–∏—Å–æ—Ç—É –ø–∞–Ω–µ–ª—ñ
                    const safeBottom = 80 + navBarHeight;
                    const hintBottom = 120 + navBarHeight;
                    
                    this.videoControls.style.bottom = `${safeBottom}px`;
                    this.markerHint.style.bottom = `${hintBottom}px`;
                }
                // –Ø–∫—â–æ –Ω—ñ ‚Äî CSS –∑ env() –≤–∂–µ –æ–±—Ä–æ–±–∏—Ç—å
            }

            resizeCanvas() {
                const dpr = window.devicePixelRatio || 1;
                this.gameCanvas.width = window.innerWidth * dpr;
                this.gameCanvas.height = window.innerHeight * dpr;
                this.gameCanvas.style.width = `${window.innerWidth}px`;
                this.gameCanvas.style.height = `${window.innerHeight}px`;
                this.ctx.scale(dpr, dpr);
            }

            throttledResize() {
                clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => this.resizeCanvas(), 100);
            }

            spawnItem() {
                if (!this.gameState.gameActive) return;
                const now = performance.now();
                if (now - this.gameState.lastSpawnTime < this.gameState.SPAWN_INTERVAL) return;

                const isWing = Math.random() < this.gameState.WING_PROBABILITY;
                const emoji = isWing ? 'ü™Ω' : ['üéÇ', 'üç∑', 'üéÅ', 'üåπ', 'üòÇ'][Math.floor(Math.random() * 5)];

                this.gameState.fallingItems.push({
                    x: Math.random() * (window.innerWidth - 60) + 30,
                    y: -60,
                    size: 32 + Math.random() * 20,
                    speed: 2 + Math.random() * 3,
                    emoji,
                    isWing,
                    id: now + Math.random()
                });

                this.gameState.lastSpawnTime = now;
            }

            update() {
                if (!this.gameState.gameActive) return;

                this.ctx.clearRect(0, 0, this.gameCanvas.width, this.gameCanvas.height);
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';

                for (let i = this.gameState.fallingItems.length - 1; i >= 0; i--) {
                    const item = this.gameState.fallingItems[i];
                    item.y += item.speed;
                    this.ctx.font = `bold ${item.size}px sans-serif`;
                    this.ctx.fillText(item.emoji, item.x, item.y);

                    if (item.y > window.innerHeight + 100) {
                        this.gameState.fallingItems.splice(i, 1);
                    }
                }

                this.spawnItem();
                this.gameState.animationId = requestAnimationFrame(() => this.update());
            }

            handleTap(event) {
                if (!this.gameState.gameActive) return;
                const rect = this.gameCanvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                let hit = false;
                for (let i = this.gameState.fallingItems.length - 1; i >= 0; i--) {
                    const item = this.gameState.fallingItems[i];
                    const dx = x - item.x;
                    const dy = y - item.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    if (distance < item.size * 0.6) {
                        hit = true;
                        const isWing = item.isWing;
                        this.gameState.fallingItems.splice(i, 1);
                        if (isWing) {
                            this.gameState.score++;
                            this.updateScore();
                            this.showFeedback('+1 –∫—Ä–∏–ª–æ! ü™Ω', true);
                            if (this.gameState.score >= this.gameState.TARGET_SCORE) {
                                this.endGame(true);
                            }
                        } else {
                            this.showFeedback('–û–π, —â–µ –±–µ–∑ –∫—Ä–∏–ª üòÖ', false);
                        }
                        break;
                    }
                }
                if (!hit) this.showFeedback('–ú—ñ–º–æ! üëÜ', false);
            }

            startGame() {
                if (this.gameState.gameActive) return;
                this.gameState.gameActive = true;
                this.gameState.score = 0;
                this.gameState.fallingItems = [];
                this.updateScore();
                this.showHUD(true);
                this.showVideoControls(true);
                this.hideVictory();
                this.update();
            }

            endGame(isWin) {
                this.gameState.gameActive = false;
                if (this.gameState.animationId) {
                    cancelAnimationFrame(this.gameState.animationId);
                    this.gameState.animationId = null;
                }
                if (isWin) this.showVictory();
            }

            restartGame() {
                this.hideVictory();
                this.startGame();
            }

            updateScore() {
                this.scoreEl.textContent = `–ö—Ä–∏–ª–∞: ${this.gameState.score}/${this.gameState.TARGET_SCORE}`;
            }

            async toggleSound() {
                this.gameState.soundEnabled = !this.gameState.soundEnabled;
                this.videoEl.muted = !this.gameState.soundEnabled;
                if (this.gameState.soundEnabled) {
                    this.soundBtn.textContent = 'üîä –í–∏–º–∫. –∑–≤—É–∫';
                    this.soundBtn.classList.add('on');
                    this.showFeedback('–ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ üîä', true);
                    try { await this.videoEl.play(); } catch (e) { console.warn('Audio play failed'); }
                } else {
                    this.soundBtn.textContent = 'üîá –£–≤—ñ–º–∫. –∑–≤—É–∫';
                    this.soundBtn.classList.remove('on');
                    this.showFeedback('–ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ üîá', false);
                }
            }

            replayVideo() {
                this.videoEl.currentTime = 0;
                this.videoEl.play().catch(e => console.warn('Replay failed'));
                this.showFeedback('–í—ñ–¥–µ–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ üîÑ', true);
            }

            showFeedback(text, isGood = true) {
                this.feedbackEl.textContent = text;
                this.feedbackEl.style.color = isGood ? '#d4af37' : '#ff6b6b';
                this.feedbackEl.classList.add('visible');
                setTimeout(() => this.feedbackEl.classList.remove('visible'), 1500);
            }

            showHUD(show) { show ? this.hud.classList.add('visible') : this.hud.classList.remove('visible'); }
            showVideoControls(show) { show ? this.videoControls.classList.add('visible') : this.videoControls.classList.remove('visible'); }
            showVictory() { this.victoryEl.classList.add('visible'); }
            hideVictory() { this.victoryEl.classList.remove('visible'); }
            hideMarkerHint() { this.markerHint.classList.add('hidden'); }
            showMarkerHint() { this.markerHint.classList.remove('hidden'); }
            hideLoading() { this.loadingScreen.style.display = 'none'; }
            showError(msg) { this.errorMessage.textContent = msg; this.errorScreen.classList.add('visible'); this.hideLoading(); }
            hideError() { this.errorScreen.classList.remove('visible'); }

            handleARLoad() {
                this.hideLoading();
                this.scene.classList.add('ready');
            }

            handleTargetFound() {
                this.gameState.isMarkerFound = true;
                this.hideMarkerHint();
                this.videoEntity.setAttribute('visible', true);
                this.videoEl.play().catch(e => console.warn('Autoplay failed'));
                this.startGame();
            }

            handleTargetLost() {
                this.gameState.isMarkerFound = false;
                this.videoEntity.setAttribute('visible', false);
                if (!this.videoEl.paused) this.videoEl.pause();
                this.gameState.gameActive = false;
                if (this.gameState.animationId) {
                    cancelAnimationFrame(this.gameState.animationId);
                    this.gameState.animationId = null;
                }
                this.showHUD(false);
                this.showVideoControls(false);
                this.hideVictory();
                this.gameState.fallingItems = [];
                this.showMarkerHint();
            }

            handleGlobalError(e) { this.showError('–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞'); }
            handleVideoError(e) { this.showFeedback('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–µ–æ', false); }
            handleARError(e) { this.showError('–ü–æ–º–∏–ª–∫–∞ AR: ' + (e.detail || '')); }
            handleVideoLoad() { console.log('Video loaded'); }
            handleVideoEnd() { this.showFeedback('–í—ñ–¥–µ–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! ‚ñ∂Ô∏è', true); }

            retryAR() {
                this.hideError();
                this.loadingScreen.style.display = 'flex';
                setTimeout(() => window.location.reload(), 500);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => new ARGame());
        } else {
            new ARGame();
        }
    </script>
</body>
</html>


