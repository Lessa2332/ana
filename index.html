<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>–ê–Ω—è</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --text: #f7f3f0;
        }
        html, body {
            height: 100%;
            margin: 0;
            color: var(--text);
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
            background: #000;
        }

        a-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* HUD –ø–æ–≤–µ—Ä—Ö AR */
        .ar-hud {
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
            color: white;
            text-align: center;
            padding: 0 16px;
            max-width: 90%;
        }

        .instructions {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
            background: rgba(0,0,0,0.5);
            padding: 4px 10px;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }

        .score-display {
            font-size: 18px;
            font-weight: 800;
            color: var(--gold);
            background: rgba(0,0,0,0.5);
            padding: 4px 12px;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }

        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: 800;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8);
        }

        .victory-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            font-weight: 800;
            color: var(--gold);
            z-index: 60;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 16px;
            border-radius: 12px;
            backdrop-filter: blur(6px);
            display: none;
            max-width: 80%;
        }

        #markerHint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: var(--gold);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            z-index: 30;
            display: block;
        }

        .btn-controls {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 40;
            display: flex;
            gap: 8px;
        }

        .btn {
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.35));
            border: 1px solid rgba(212, 175, 55, 0.15);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--gold);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(4px);
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <div class="arjs-loader" id="loader">
        <h2 class="pulse">–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞ ü™Ω</h2>
        <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏...</div>
    </div>

    <!-- HUD –ø–æ–≤–µ—Ä—Ö AR -->
    <div class="ar-hud" id="arHud" style="display: none;">
        <div class="instructions">–õ–æ–≤–∏ —Ç—ñ–ª—å–∫–∏ –∫—Ä–∏–ª–∞ ü™Ω</div>
        <div class="score-display" id="scoreDisplay">–ö—Ä–∏–ª–∞: 0/10</div>
    </div>

    <div class="btn-controls">
        <button id="btnPlay" class="btn" title="Play video">‚ñ∂</button>
        <button id="btnStop" class="btn" title="Stop video">‚è∏</button>
    </div>

    <div class="feedback" id="feedback"></div>
    <div class="victory-message" id="victoryMessage"></div>

    <a-scene
        mindar-image="imageTargetSrc: https://lessa2332.github.io/ana/marker.mind; autoStart: true; uiLoading: no; uiError: no;"
        embedded
        color-space="sRGB"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">

        <a-assets>
            <video id="video1" src="video1.mp4" playsinline webkit-playsinline preload="auto" loop="false"></video>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="targetRoot">
            <!-- –í—ñ–¥–µ–æ –ê–Ω–∏ -->
            <a-plane id="videoPlane" position="0 0 0" width="0.85" height="1.5" 
                     material="shader: flat; src: #video1; transparent: false;" visible="false"></a-plane>

            <!-- –¢—É—Ç –±—É–¥—É—Ç—å –∫—Ä–∏–ª–∞ (–¥–æ–¥–∞—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ —á–µ—Ä–µ–∑ JS) -->
        </a-entity>
    </a-scene>

    <div id="markerHint">–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω</div>

    <script>
        // –ï–ª–µ–º–µ–Ω—Ç–∏
        const videoEl = document.getElementById('video1');
        const btnPlay = document.getElementById('btnPlay');
        const btnStop = document.getElementById('btnStop');
        const loader = document.getElementById('loader');
        const arHud = document.getElementById('arHud');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const feedbackEl = document.getElementById('feedback');
        const victoryMessage = document.getElementById('victoryMessage');
        const markerHint = document.getElementById('markerHint');
        const videoPlane = document.getElementById('videoPlane');
        const targetRoot = document.getElementById('targetRoot');

        let isMarkerFound = false;
        let score = 0;
        const targetScore = 10;
        const goodEmoji = 'ü™Ω';
        const allEmojis = ['ü™Ω', 'üéÇ', 'üç∑', 'üéÅ', 'üåπ', 'üòÇ'];
        let wingEntities = []; // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫—Ä–∏–ª–∞ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        let gameActive = false;
        let spawnInterval;

        // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É
        function showMarkerHint(text, duration = 3000) {
            markerHint.textContent = text;
            markerHint.style.display = 'block';
            setTimeout(() => { markerHint.style.display = 'none'; }, duration);
        }

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function showFeedback(text, isGood = true) {
            feedbackEl.textContent = text;
            feedbackEl.style.color = isGood ? '#d4af37' : '#fff';
            feedbackEl.style.opacity = '1';
            setTimeout(() => {
                feedbackEl.style.opacity = '0';
            }, 800);
        }

        // –ü–æ—á–∞—Ç–∏ –≥—Ä—É –≤ AR
        function startARGame() {
            if (gameActive) return;
            gameActive = true;
            score = 0;
            scoreDisplay.textContent = `–ö—Ä–∏–ª–∞: ${score}/${targetScore}`;
            arHud.style.display = 'flex';
            victoryMessage.style.display = 'none';

            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫—Ä–∏–ª–∞ –∫–æ–∂–Ω—ñ 1.2 —Å–µ–∫—É–Ω–¥–∏
            spawnInterval = setInterval(spawnWing, 1200);
            spawnWing(); // –æ–¥—Ä–∞–∑—É –æ–¥–Ω–µ
        }

        // –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–¥–Ω–µ –∫—Ä–∏–ª–æ (–∞–±–æ —ñ–Ω—à–∏–π –µ–º–æ–¥–∑—ñ)
        function spawnWing() {
            if (!gameActive || wingEntities.length >= 6) return;

            const emoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
            const size = 0.1 + Math.random() * 0.08; // —Ä–æ–∑–º—ñ—Ä —É –º–µ—Ç—Ä–∞—Ö
            const x = (Math.random() - 0.5) * 0.6; // -0.3 –¥–æ +0.3
            const z = -0.1 - Math.random() * 0.2;  // —Ç—Ä–æ—Ö–∏ –≤–≥–ª–∏–±

            const wing = document.createElement('a-entity');
            wing.setAttribute('position', `${x} 0.3 ${z}`);
            wing.setAttribute('text', {
                value: emoji,
                align: 'center',
                width: 1,
                color: emoji === 'ü™Ω' ? '#d4af37' : '#fff'
            });
            wing.setAttribute('scale', `${size} ${size} ${size}`);
            wing.classList.add('wing');
            wing.dataset.emoji = emoji;

            // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é: –ø–æ–≤—ñ–ª—å–Ω–∏–π —Ä—É—Ö –≤–≥–æ—Ä—É —Ç–∞ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
            wing.setAttribute('animation__move', {
                property: 'position',
                to: `${x} 0.8 ${z}`,
                dur: 3000 + Math.random() * 2000,
                easing: 'linear'
            });
            wing.setAttribute('animation__rotate', {
                property: 'rotation',
                to: `0 ${360} 0`,
                loop: 'true',
                dur: 2000,
                easing: 'linear'
            });

            targetRoot.appendChild(wing);
            wingEntities.push(wing);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª—è—Ç–∏ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥–∏
            setTimeout(() => {
                if (wing.parentNode) {
                    wing.parentNode.removeChild(wing);
                    const index = wingEntities.indexOf(wing);
                    if (index > -1) wingEntities.splice(index, 1);
                }
            }, 4000);
        }

        // –û–±—Ä–æ–±–∫–∞ –¥–æ—Ç–∏–∫—É –ø–æ —Å—Ü–µ–Ω—ñ
        document.body.addEventListener('click', (e) => {
            if (!gameActive || !isMarkerFound) return;

            // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ 2D-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ 3D-–ø—Ä–æ–º—ñ–Ω—å (raycaster)
            const scene = document.querySelector('a-scene');
            const mouse = {
                x: (e.clientX / window.innerWidth) * 2 - 1,
                y: -(e.clientY / window.innerHeight) * 2 + 1
            };

            const raycaster = new THREE.Raycaster();
            const camera = scene.camera;
            raycaster.setFromCamera(mouse, camera);

            // –®—É–∫–∞—î–º–æ –ø–µ—Ä–µ—Ç–∏–Ω –∑ –∫—Ä–∏–ª–∞–º–∏
            const wings = document.querySelectorAll('.wing');
            const intersections = [];
            wings.forEach(wing => {
                const el = wing.object3D;
                if (el) {
                    const intersects = raycaster.intersectObject(el, true);
                    if (intersects.length > 0) {
                        intersections.push({ wing, distance: intersects[0].distance });
                    }
                }
            });

            if (intersections.length > 0) {
                // –ë–µ—Ä–µ–º–æ –Ω–∞–π–±–ª–∏–∂—á–µ –∫—Ä–∏–ª–æ
                intersections.sort((a, b) => a.distance - b.distance);
                const closest = intersections[0].wing;
                const emoji = closest.dataset.emoji;

                // –í–∏–¥–∞–ª—è—î–º–æ –∫—Ä–∏–ª–æ
                if (closest.parentNode) {
                    closest.parentNode.removeChild(closest);
                    const index = wingEntities.indexOf(closest);
                    if (index > -1) wingEntities.splice(index, 1);
                }

                if (emoji === goodEmoji) {
                    score++;
                    scoreDisplay.textContent = `–ö—Ä–∏–ª–∞: ${score}/${targetScore}`;
                    showFeedback('+1 –∫—Ä–∏–ª–æ! ü™Ω', true);
                    if (score >= targetScore) {
                        endGame(true);
                    }
                } else {
                    showFeedback('–û–π, —â–µ –±–µ–∑ –∫—Ä–∏–ª üòÖ', false);
                }
            }
        });

        function endGame(isWin) {
            gameActive = false;
            clearInterval(spawnInterval);
            // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∫—Ä–∏–ª–∞
            wingEntities.forEach(wing => {
                if (wing.parentNode) wing.parentNode.removeChild(wing);
            });
            wingEntities = [];

            if (isWin) {
                victoryMessage.textContent = '–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞! üíã';
                victoryMessage.style.display = 'block';
                // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏ ‚Äî —Å—Ö–æ–≤–∞—Ç–∏ —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≥—Ä—É
                setTimeout(() => {
                    victoryMessage.style.display = 'none';
                    startARGame(); // –Ω–æ–≤–∞ —Å–ø—Ä–æ–±–∞
                }, 3000);
            }
        }

        // --- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥–µ–æ ---
        btnPlay.addEventListener('click', function() {
            if (isMarkerFound) {
                videoEl.muted = false;
                videoEl.play().catch(() => {});
            } else {
                showMarkerHint('–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω');
            }
        });

        btnStop.addEventListener('click', function() {
            if (isMarkerFound) {
                videoEl.pause();
                videoEl.currentTime = 0;
            } else {
                showMarkerHint('–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω');
            }
        });

        // --- –ü–æ–¥—ñ—ó AR ---
        const scene = document.querySelector('a-scene');

        scene.addEventListener('renderstart', () => {
            if (loader) loader.style.display = 'none';
            const ui = document.querySelector('.mindar-ui-overlay');
            if (ui) ui.style.display = 'none';
        });

        scene.addEventListener('targetFound', () => {
            isMarkerFound = true;
            markerHint.style.display = 'none';
            videoPlane.setAttribute('visible', 'true');
            videoEl.muted = false;
            videoEl.play().catch(() => {});
            startARGame(); // ‚ú® –≥—Ä–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è!
        });

        scene.addEventListener('targetLost', () => {
            isMarkerFound = false;
            if (!videoEl.paused) {
                videoEl.pause();
                videoEl.currentTime = 0;
            }
            videoPlane.setAttribute('visible', 'false');
            gameActive = false;
            clearInterval(spawnInterval);
            arHud.style.display = 'none';
            victoryMessage.style.display = 'none';
            wingEntities.forEach(wing => {
                if (wing.parentNode) wing.parentNode.removeChild(wing);
            });
            wingEntities = [];
        });

        // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ø—ñ–¥–∫–∞–∑–∫–∞
        setTimeout(() => { markerHint.style.display = 'none'; }, 4000);
    </script>
</body>
</html>
